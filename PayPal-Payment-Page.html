<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout with PayPal</title>
    <style>
        h1 { text-align: center; }
    </style>
</head>
<body>
    <h1>Complete Checkout</h1>

    <div id="paypal-button-container"></div>

    <script src="https://www.paypal.com/sdk/js?client-id=AYy6HZjrCWwMG1gzVsFCUgNZnuYFFtePVmAo8zgsk9syXLfkEGLdHjTazOh427K5_Vcn5-ZPbpLIy_IT"></script>
    <script>
        // These values will be dynamically passed from your app
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get("email");
        const amount = urlParams.get("amount");
        const planName = urlParams.get("plan_name");
        const baserowTableID = urlParams.get("table_id");
        const baserowToken = urlParams.get("token");

        if (!email || !amount || !planName || !baserowTableID || !baserowToken) {
            alert("Missing required parameters.");
            throw new Error("Missing required parameters.");
        }

        paypal.Buttons({
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: { value: amount }
                    }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                    alert('Transaction completed by ' + details.payer.name.given_name + '!');

                    const workerURL = "https://paypal-payment-page.alexskeioslav.workers.dev/"; 

                    fetch(workerURL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            email: email,
                            amount: amount,
                            transaction_id: details.id,
                            plan_name: planName,
                            table_id: baserowTableID,
                            token: baserowToken
                        })
                    })
                    .then(response => response.json())
                    .then(data => console.log("Payment data sent:", data))
                    .catch(error => console.error("Error:", error));
                });
            },
            onCancel: function(data) {
                console.warn("Transaction was canceled by the user.");
            },
            onError: function(err) {
                console.error("Error during transaction:", err);
            }
        }).render("#paypal-button-container");
    </script>
</body>
</html>

