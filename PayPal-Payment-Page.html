<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout with PayPal</title>
    <style>
        h1 {
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Complete Checkout</h1>
    
    <div id="paypal-button-container"></div>
    
    <script src="https://www.paypal.com/sdk/js?client-id=AYy6HZjrCWwMG1gzVsFCUgNZnuYFFtePVmAo8zgsk9syXLfkEGLdHjTazOh427K5_Vcn5-ZPbpLIy_IT"></script>
    <script>
        // Get parameters from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const planName = urlParams.get('plan_name');
        const amount = urlParams.get('amount');
        const email = urlParams.get('email');
        const tableId = urlParams.get('table_id');
        const token = urlParams.get('token');
        const successPage = urlParams.get('success_page'); // Success Page URL

        paypal.Buttons({
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: { value: amount } // Dynamic amount
                    }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                    // Prepare payment data
                    const paymentData = {
                        email: details.payer.email_address,
                        amount: details.purchase_units[0].amount.value,
                        transaction_id: details.id,
                        paid_at: new Date().toISOString(),
                        plan_name: planName,
                        table_id: tableId,
                        token: token
                    };

                    // Send payment data to Cloudflare Worker in the background
                    fetch('https://paypal-payment-page.alexskeioslav.workers.dev/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(paymentData),
                        keepalive: true // Ensures the request is completed even after page unload
                    }).catch(error => console.error('Error sending data:', error));

                    // Immediately redirect to Success Page
                    window.location.href = `${successPage}?deep_link=${encodeURIComponent(successPage)}`;
                });
            }
        }).render('#paypal-button-container');
    </script>
</body>
</html>
